<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Macha Viewer</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; display: flex; flex-direction: column; height: 100vh; }
#main { display: flex; flex: 1; overflow: hidden; }
#sidebar { width: 280px; min-width: 280px; background: #f8f9fa; border-right: 1px solid #dee2e6; display: flex; flex-direction: column; }
#search { padding: 12px; border: none; border-bottom: 1px solid #dee2e6; font-size: 14px; outline: none; background: #fff; }
#search:focus { box-shadow: inset 0 -2px 0 #0d6efd; }
#controls { display: flex; align-items: center; padding: 6px 12px; border-bottom: 1px solid #dee2e6; gap: 6px; }
#controls span { font-size: 12px; color: #6c757d; }
.sort-btn { font-size: 11px; padding: 2px 8px; border: 1px solid #dee2e6; border-radius: 3px; background: #fff; cursor: pointer; }
.sort-btn.active { background: #0d6efd; color: #fff; border-color: #0d6efd; }
#file-list { list-style: none; overflow-y: auto; flex: 1; }
#file-list li { padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 13px; display: flex; align-items: center; gap: 6px; }
#file-list li:hover { background: #e9ecef; }
#file-list li.active { background: #0d6efd; color: #fff; }
#file-list li.active .badge { background: #fff; color: #333; }
.badge { display: inline-block; font-size: 10px; padding: 2px 5px; border-radius: 3px; font-weight: 500; white-space: nowrap; flex-shrink: 0; }
.badge-strong { background: #d4edda; color: #155724; }
.badge-good { background: #cce5ff; color: #004085; }
.badge-moderate { background: #fff3cd; color: #856404; }
.badge-stretch { background: #f8d7da; color: #721c24; }
.title-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
#count { padding: 8px 12px; font-size: 12px; color: #6c757d; border-bottom: 1px solid #dee2e6; }
#content-wrap { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
#actions { padding: 8px 16px; border-bottom: 1px solid #dee2e6; display: none; gap: 8px; align-items: center; }
#actions button { font-size: 12px; padding: 4px 12px; border: none; border-radius: 3px; cursor: pointer; }
#btn-apply { background: #28a745; color: #fff; }
#btn-discard { background: #dc3545; color: #fff; }
#btn-apply:hover { background: #218838; }
#btn-discard:hover { background: #c82333; }
#content { flex: 1; overflow-y: auto; padding: 32px 48px; }
#content h1 { margin-bottom: 16px; color: #212529; }
#content h2 { margin-top: 24px; margin-bottom: 12px; color: #495057; border-bottom: 1px solid #dee2e6; padding-bottom: 6px; }
#content p { margin-bottom: 12px; line-height: 1.6; color: #333; }
#content ul, #content ol { margin-bottom: 12px; padding-left: 24px; }
#content li { margin-bottom: 4px; line-height: 1.5; }
#content a { color: #0d6efd; }
#content strong { color: #212529; }
#notes-wrap { padding: 12px 48px 16px; border-top: 1px solid #dee2e6; display: none; }
#notes-wrap label { font-size: 12px; font-weight: 600; color: #495057; display: block; margin-bottom: 4px; }
#notes { width: 100%; height: 80px; font-size: 13px; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px; resize: vertical; font-family: inherit; }
#notes-status { font-size: 11px; color: #6c757d; margin-top: 4px; }
#footer { padding: 6px 16px; background: #f8f9fa; border-top: 1px solid #dee2e6; font-size: 12px; color: #495057; display: flex; gap: 16px; flex-wrap: wrap; }
.stat-item { white-space: nowrap; }
.stat-label { font-weight: 600; }
.stat-detail { color: #6c757d; }
</style>
</head>
<body>
<div id="main">
<div id="sidebar">
  <input id="search" type="text" placeholder="Filter applications..." />
  <div id="controls">
    <span>Sort:</span>
    <button class="sort-btn active" data-sort="fit">Fit</button>
    <button class="sort-btn" data-sort="date">Date</button>
    <button class="sort-btn" data-sort="name">Name</button>
  </div>
  <div id="count"></div>
  <ul id="file-list"></ul>
</div>
<div id="content-wrap">
  <div id="actions">
    <button id="btn-apply">Applied</button>
    <button id="btn-discard">Discard</button>
  </div>
  <div id="content">
    <p style="color:#6c757d;margin-top:40vh;text-align:center">Select an application from the sidebar</p>
  </div>
  <div id="notes-wrap">
    <label>Notes</label>
    <textarea id="notes" placeholder="Add notes..."></textarea>
    <div id="notes-status"></div>
  </div>
</div>
</div>
<div id="footer"></div>
<script>
let allFiles = [];
let currentFile = null;
let currentSort = 'fit';
const list = document.getElementById('file-list');
const content = document.getElementById('content');
const search = document.getElementById('search');
const countEl = document.getElementById('count');
const actions = document.getElementById('actions');
const notesWrap = document.getElementById('notes-wrap');
const notesEl = document.getElementById('notes');
const notesStatus = document.getElementById('notes-status');
const footer = document.getElementById('footer');

const fitOrder = { 'strong': 0, 'good': 1, 'moderate': 2, 'stretch': 3, '': 4 };

function fitRank(fit) {
  const f = fit.toLowerCase();
  for (const key in fitOrder) {
    if (f.includes(key)) return fitOrder[key];
  }
  return 4;
}

function badgeClass(fit) {
  const f = fit.toLowerCase();
  if (f.includes('strong')) return 'badge-strong';
  if (f.includes('good')) return 'badge-good';
  if (f.includes('moderate')) return 'badge-moderate';
  return 'badge-stretch';
}

function sortFiles(files) {
  return [...files].sort((a, b) => {
    if (currentSort === 'fit') return fitRank(a.fit) - fitRank(b.fit);
    if (currentSort === 'date') return b.timestamp - a.timestamp;
    return a.title.localeCompare(b.title);
  });
}

function renderList(files) {
  const sorted = sortFiles(files);
  list.innerHTML = '';
  countEl.textContent = sorted.length + ' application' + (sorted.length !== 1 ? 's' : '');
  sorted.forEach(f => {
    const li = document.createElement('li');
    li.dataset.filename = f.filename;
    const badge = f.fit ? '<span class="badge ' + badgeClass(f.fit) + '">' + escapeHtml(f.fit) + '</span>' : '';
    li.innerHTML = badge + '<span class="title-text">' + escapeHtml(f.title) + '</span>';
    li.onclick = () => loadFile(f.filename, li);
    list.appendChild(li);
  });
}

function escapeHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

async function loadFile(filename, li) {
  document.querySelectorAll('#file-list li').forEach(el => el.classList.remove('active'));
  if (li) li.classList.add('active');
  currentFile = filename;
  const res = await fetch('/api/file/' + encodeURIComponent(filename));
  const html = await res.text();
  content.innerHTML = html;
  actions.style.display = 'flex';
  notesWrap.style.display = 'block';
  // Extract existing notes from rendered content
  const notesMatch = html.match(/<h2>Notes<\/h2>\s*([\s\S]*?)$/i);
  notesEl.value = notesMatch ? stripHtml(notesMatch[1]).trim() : '';
  notesStatus.textContent = '';
}

function stripHtml(html) {
  const div = document.createElement('div');
  div.innerHTML = html;
  return div.textContent || '';
}

async function applyFile() {
  if (!currentFile) return;
  await fetch('/api/file/' + encodeURIComponent(currentFile) + '/apply', { method: 'POST' });
  removeCurrentFile();
}

async function discardFile() {
  if (!currentFile) return;
  await fetch('/api/file/' + encodeURIComponent(currentFile) + '/discard', { method: 'POST' });
  removeCurrentFile();
}

function removeCurrentFile() {
  allFiles = allFiles.filter(f => f.filename !== currentFile);
  currentFile = null;
  actions.style.display = 'none';
  notesWrap.style.display = 'none';
  content.innerHTML = '<p style="color:#6c757d;margin-top:40vh;text-align:center">Select an application from the sidebar</p>';
  renderList(getFiltered());
  loadStats();
}

let notesTimeout = null;
notesEl.addEventListener('input', () => {
  if (!currentFile) return;
  clearTimeout(notesTimeout);
  notesStatus.textContent = 'saving...';
  notesTimeout = setTimeout(async () => {
    await fetch('/api/file/' + encodeURIComponent(currentFile) + '/notes', {
      method: 'POST',
      body: notesEl.value
    });
    notesStatus.textContent = 'saved';
    setTimeout(() => { notesStatus.textContent = ''; }, 2000);
  }, 800);
});

function getFiltered() {
  const q = search.value.toLowerCase();
  if (!q) return allFiles;
  return allFiles.filter(f => f.title.toLowerCase().includes(q) || f.fit.toLowerCase().includes(q));
}

search.addEventListener('input', () => renderList(getFiltered()));

document.querySelectorAll('.sort-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentSort = btn.dataset.sort;
    renderList(getFiltered());
  });
});

document.getElementById('btn-apply').addEventListener('click', applyFile);
document.getElementById('btn-discard').addEventListener('click', discardFile);

async function loadStats() {
  try {
    const res = await fetch('/api/stats');
    const stats = await res.json();
    footer.innerHTML = formatStats(stats);
  } catch(e) { /* ignore */ }
}

function formatStats(s) {
  return statItem('Applications', s.applications)
    + statItem('Done', s.done)
    + statItem('Discarded', s.discarded)
    + statItem('Queue', s.queue);
}

function statItem(label, d) {
  let detail = '';
  if (d.today > 0 || d.week > 0) {
    const parts = [];
    if (d.today > 0) parts.push(d.today + ' today');
    if (d.week > 0) parts.push(d.week + ' this week');
    if (d.month > 0 && d.month !== d.total) parts.push(d.month + ' this month');
    detail = ' <span class="stat-detail">(' + parts.join(', ') + ')</span>';
  }
  return '<span class="stat-item"><span class="stat-label">' + label + ':</span> ' + d.total + detail + '</span>';
}

fetch('/api/files').then(r => r.json()).then(files => {
  allFiles = files;
  renderList(allFiles);
});
loadStats();
</script>
</body>
</html>
